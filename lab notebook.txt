Lab notebook, single-cell

2021-02-26

DATA

##################################

2/26/2021
From https://support.10xgenomics.com/single-cell-multiome-atac-gex/software/pipelines/latest/using/count

File Name	Description
web_summary.html	Run summary metrics and charts in HTML format.
summary.csv	Run summary metrics in CSV format.
raw_feature_bc_matrix.h5	Raw feature barcode matrix stored as a CSC sparse matrix in hdf5 format. The rows consist of all the gene and peak features concatenated together and the columns consist of all possible barcode sequences (numbering 736,320).
raw_feature_bc_matrix	Raw feature barcode matrix stored as a CSC sparse matrix in MEX format. The rows consist of all the gene and peak features concatenated together and the columns consist of all possible barcode sequences (numbering 736,320).
per_barcode_metrics.csv	ATAC and GEX read count summaries generated for every barcode observed in the experiment. For more details see Per-barcode metrics.
gex_possorted_bam.bam	GEX reads aligned to the genome and transcriptome annotated with barcode information in BAM format.
gex_possorted_bam.bam.bai	Index for gex_possorted_bam.bam.
gex_molecule_info.h5	Count and barcode information for every GEX molecule observed in the experiment in hdf5 format.
filtered_feature_bc_matrix.h5	Filtered feature barcode matrix stored as a CSC sparse matrix in hdf5 format. The rows consist of all the gene and peak features concatenated together (identical to raw feature barcode matrix) and the columns are restricted to those barcodes that are identified as cells.
filtered_feature_bc_matrix	Filtered feature barcode matrix stored as a CSC sparse matrix in MEX format. The rows consist of all the gene and peak features concatenated together (identical to raw feature barcode matrix) and the columns are restricted to those barcodes that are identified as cells.
cloupe.cloupe	Loupe Browser visualization file with all the analysis outputs.
atac_possorted_bam.bam.bai	ATAC reads aligned to the genome annotated with barcode information in BAM format.
atac_possorted_bam.bam	Index for atac_possorted_bam.bam.
atac_peaks.bed	Locations of open-chromatin regions identified in this sample. These regions are referred to as "peaks".
atac_peak_annotation.tsv	Annotations of peaks based on genomic proximity alone. Note that these are not functional annotations and they do not make use of linkage with GEX data.
atac_fragments.tsv.gz	Count and barcode information for every ATAC fragment observed in the experiment in TSV format.
atac_fragments.tsv.gz.tbi	Index for atac_fragments.tsv.gz.
atac_cut_sites.bigwig	Genome track of observed transposition sites in the experiment smoothed at a resolution of 400 bases in BIGWIG format.
analysis	Various secondary analyses that utilize the ATAC data, the GEX data, and their linkage: dimensionality reduction and clustering results for the ATAC and GEX data, differential expression, and differential accessibility for all clustering results above and linkage between ATAC and GEX data. See Analysis Overview for more information.

2/26/2021

Data exploration, RCMB56

web_summary.html
	Our data have low ATAC and RNA coverage, as expected for lcWGS QC.
	Estimated number of cells	10,738
	Clustering done separately on RNA and ATAC features. Can I find a joint classifier?
	ATAC:
		Median high-quality fragments per cell	1,414
		Number of peaks	184,234
	RNA:
		Median genes per cell	161
		Total genes detected	20,965

Read filtering
ATAC
	Each unique genomic region can only map to at most 1 ATAC read
	(Why not use barcodes to distinguish duplicates?)
RNA
	Counts include transcriptomic, intronic and exonic reads.
	

Dimensionality reduction
RNA
	PCA (IRLBA algorithm), 10 components.
ATAC
	Inverse-document frequency (idf) transform (greater weight to counts of peaks which occur in few barcodes)
	SVD (IRLBA), 15 components
	Depth normalization - each barcode to L2 norm in 15d.
	Spherical k-means

Clustering & Visualization - on DR data
	spherical k-means
	t-SNE
	UMAP

Why do I have 2 almost identical differential_expression.csv files under both ATAC and gex?

2/26/2021

Papers & Resources
CellRanger multiome docs
	https://support.10xgenomics.com/single-cell-multiome-atac-gex/software/overview/welcome


2/26/2021

Loupe Tutorial
Loupe is the broswer for copy number estimation in CellRanger's single-cell DNA
pipeline. Notably not ATAC, but let's see what it can do.

Basic functionality: Hierarchical clustering groups cells on the right by CN (20MB bins).
Can zoom, get a region/gene, or get a subtree. Top browser shows current node's descendants;
bottom browser shows node.

Docs
CellRanger DNA:
	https://support.10xgenomics.com/single-cell-dna/software/pipelines/latest/what-is-cell-ranger-dna
Tutorial:
	https://support.10xgenomics.com/single-cell-dna/software/visualization/latest/tutorial-1-introduction
Copy-number calling algorithm:
	https://support.10xgenomics.com/single-cell-dna/software/pipelines/latest/algorithms/clustering


6/10/2021

case23 download scRNA+ATAC from Sebastian
md5sums checked
/expanse/lustre/projects/csd677/collab/data/scRNA+ATAC/RCMB56-ht/deep

6/10/2021

CellRanger metrics

pdx: 1 warning: number of detected cells is high. Ideally <10.000.
ht: 0 warnings.
Est number of cells
	pdx 12863	
	ht 4624	4473
Median ATAC fragments per cell
	pdx 5050	
	ht 12327	11711
GEx median genes expressed per cell
	pdx 2765	
	ht 1575	1525

6/11/2021
Transferred Mariya's project directory. See
/expanse/lustre/projects/csd677/collab/projects/Kazachkova_rotation_sp21.zip

6/11/2021

Run CellRanger 2.0.0 on RCMB56 pdx, ht datasets.

METHODS
Cluster mode - see https://support.10xgenomics.com/single-cell-multiome-atac-gex/software/pipelines/latest/advanced/cluster-mode


4/15/2021

Yingxi meeting

GOAL: ssGSEA on metacells. 

METHODS
Removed all zeroes from each sample, then took intersection of these.
Ran ssGSEA.

Anthony: Look at the hierarchical clustering.



6/17/2021

Yingxi meeting with anthony.

Seem to have 3 meta-clusters of metacells:
6_0, 6_1, 6_2, 1 - MYC, MTORC1, mitotic spindle, DNA repair, estrogen response.
0, 5, 3, 8, 10, 9 - Angiogenesis, KRAS down, WNT B-catenin
4, 2, 7 - Protein secretion, KRAS signalling, pancreatic beta cells, KRAS dn.

Could run velocity analysis:
	VeloCyto
	https://velocyto.org/velocyto.py/tutorial/cli.html#run10x-run-on-10x-chromium-samples
	https://academic.oup.com/database/article/doi/10.1093/database/baz046/5427041


6/22/2021

Tuesday meeting
Yingxi

- Presented hierarchical clustering on meta-cells.
- Jill: what is the distribution of scores?
- Owen: Plot scores on 1d axis, take top 10%?
- Jill: column normalization, or no normalization on clustering.
- Jill: use GO ontology sets?
- Owen: gene sets for ecdnas 1,2,3

Hi Yingxi,
	Attached are bed files corresponding to amplified genes (including partial amplifications) on RCMB56 ecDNAs 1 and 2.I've also 
	attached a bed containing all regions I think are in ecDNA 3, but genes are not annotated on this one. 
	Outline of steps to generate a .gmt file of sets of genes corresponding to each ecDNA:
	- Download the gencode reference set. Pick your favorite format, GTF and GFF3 are pretty similar. 
	- Filter for protein-coding genes. Using awk, a template command would be:
	awk '{if($3=="transcript" && $20=="\"protein_coding\";"){print $0}}' gencode.gtf
	- Parse into bed. Keep the gene names.
	- bedtools intersect -wa will give you genes overlapping the ecDNA.
	- Parse into gmt.
Yours,Owen


6/23/2021

scATAC-seq bam files

METHODS
idk what I'm looking for; just getting familiar with the data.

RESULTS
- bam files are large - 32 and 16Gb.
- Can see the ends of the ecDNAs in the atac coverage. ht more obvious than pdx.
- peaks are highly highly enriched for signal, but they account for a minority of total sequence.
- CB is cell barcode name
- discordant reads appear in the scATAC data.
- Examining the atac_fragments.tsv.gz file, it looks like using barcode info would dramatically alter
	counts per barcode per peak - there are ~4 different cells with the same read at the beginning of
	chr1, and that's not even an ecDNA region.


6/23/2021
hdf5 format - see https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/advanced/h5_matrices
mex format - https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/output/matrices


7/1/2021

Counting reads in subset-bam

METHODS
see 2021-06-23_subset-bam.
subset-bam (10x Genomics) to get bam per barcode
featurecounts to count each ecDNA and chr2 as a control.


7/20/2021

Harmony

BACKGROUND
CellRanger aggr failed to correct batch effects. See 
/expanse/lustre/projects/csd677/yil031/scRNA_ATAC/cellranger_aggr/pdx_ht_rcmb56_aggre/outs

Quickstart:
	https://portals.broadinstitute.org/harmony/articles/quickstart.html#seurat-1
Tutorial with Seurat:
	https://portals.broadinstitute.org/harmony/SeuratV3.html


7/22/2021

ecdna-featurecounts

GOAL
Count reads mapping to each ecDNA in single cells, and also to chr2 as a control.

METHODS
/expanse/lustre/projects/csd677/collab/projects/scRNA+ATAC/2021-06-23_subset-bam/
/home/ochapman/Documents/Mesirov/scRNA+ATAC/2021-07-22_ecdna-featurecounts

RESULTS
Same as Mariya. No obvious multimodal distribution of ecDNA+/- cells. 
See updates/2021-07-28 scATAC ecDNA detection, https://docs.google.com/presentation/d/1AQFXeR_pjxxjWItUgGZ3pyrpCPetTlEkNccB3y_mRS8/edit?usp=sharing


7/27/2021

Counting read depth at random regions, mpileup

get excluded regions
	cat /expanse/lustre/projects/csd677/collab/bin/AmpliconArchitect/data_repo/GRCh38/GRCh38_merged_centromeres_conserved_sorted.bed RCMB56_ecDNA_1.hg38.bed > ecDNA1_exclude.hg38.bed
list all bam files to .txt
	find /expanse/lustre/projects/csd677/collab/projects/scRNA+ATAC/2021-06-23_subset-bam/RCMB56-ht/ -name "*.bam" -print > RCMB56-ht-bamlist.txt
index all bams
	cat RCMB56-ht-bamlist.txt | while read line; do samtools index $line; done
Oops, samtools mpileup computes depth at a single base...

Counting read depth at random regions, featurecounts

8/3/2021

Permutation test for detecting ecDNA

GOAL
We need a distribution to estimate the probability that a normal genomic region could
generate this many reads at the ecDNA locus. 

METHODS
/expanse/lustre/projects/csd677/collab/projects/scRNA+ATAC/2021-07-26_enrich_vs_permuted_bkgd/
/mnt/c/Users/ochapman/Documents/Mesirov/scRNA+ATAC/2021-08-02_featurecounts_permutation
Wrote a script to perform generate 1000 random features of the same length as the ecDNA, and 
 featurecounts each random interval for each cell.
This was clearly very inefficient. 12 hours on a dedicated compute node gave me 128 finished permutations.
Then, we can estimate p-values 2 ways:
 - empirical: how many times do we randomly get this many or more reads in a random region?
 - poisson: fit ML poisson distribution to the random permutations, compute p-value for the poisson.

RESULTS
Both implemented correctly, and both look pretty good at distinguishing ecDNA+ cells. 
Probably need more random samples to accurately estimate p-values though.
Also, the permutation test is very expensive and time-consuming.

DISCUSSION
Can we make the permutation test more efficient?
Run more permutations.

8/3/2021

Resources for Sunita

CellRanger runs at 
/expanse/lustre/projects/csd677/collab/projects/scRNA+ATAC/RCMB56-ht/cellranger-arc.sbatch
/expanse/lustre/projects/csd677/collab/projects/scRNA+ATAC/RCMB56-pdx/cellranger-arc.sbatch

8/16/2021

Alex - permutation test - any ideas?
How many sigmas?
Plot distribution of sigma values.
Is there another approach to see if a cell is ecDNA+?
sigma = sqrt(lambda)


8/31/2021

Seurat Notes

BACKGROUND
Trying to run Yingxi's code on my own jupyter notebook. Want to do a code review, and prep
teaching materials for Sunita.

Installation
conda install -c bioconda r-seurat r-signac bioconductor-bsgenome.hsapiens.ucsc.hg38 bioconductor-ensdb.hsapiens.v86 bioconductor-biovizbase
conda install r-ape # required for BuildClusterTree
conda install r-tidyverse # regular R sucks
conda install -c bioconda bioconductor-limma # FindAllMarkers prefers this implementation of Wilcoxon Rank Sum Test


8/31/2021

Is it possible to determine if a vector is approximately a linear combination of other vectors?
Yes. See https://math.stackexchange.com/questions/2190547/is-it-possible-to-determine-if-a-vector-is-approximately-a-linear-combination-of

9/1/2021

Correlations

RESULTS
RCMB56-ht, ecDNA1
 z-score vs DNTTIP2 expression
	Negative. r=0.27
 z-score vs ATAC embeddings
	PC2. r=-0.55. Relatively strong.
 z-score vs RNA embeddings
	PC2. r=0.30. Strikingly, almost all lambda >> 0 have positive values on PC2.
 
RCMB56-pdx, ecDNA1
  z-score vs DNTTIP2 expression
	Negative. r=0.48. Correlation is there but weak.
 z-score vs ATAC embeddings
	PC1. r=-0.44. Sequencing depth.
 z-score vs RNA embeddings
	PC3. r=0.19. 
	
RCMB56-ht, ecDNA2
 z-score vs ATAC embeddings
	PC9. r=-0.40. Relatively strong.
 z-score vs RNA embeddings
	PC2. r=0.20. Again, almost all lambda >> 0 have positive values on PC2.
	
RCMB56-ht, ecDNA3 
 z-score vs ATAC embeddings
	PC1. r=-0.52. Sequencing depth.
 z-score vs RNA embeddings
	PC4. r=-.17. Negative.
	
RCMB56-pdx, ecDNA2
 z-score vs ATAC embeddings
	PC9. r=-0.44. If you squint?
 z-score vs RNA embeddings
	PC2. r=-0.28. Negative.
	
RCMB56-pdx, ecDNA3
 z-score vs ATAC embeddings
	PC1. r=-0.44. Sequencing depth.
 z-score vs RNA embeddings
	PC2. r=-0.21. Negative.
	
DISCUSSION
- Weak correlation between ecDNA1 z-score and DNTTIP2 expression.
- Weak correlations between some ecDNA z-scores and cell embeddings.
- Bizarre nonlinear function relates ht ecDNAs 1 and 2 to rna pc2. 

9/2/2021

Clusters against ecDNA predictions

BACKGROUND AND METHODS
2021-08-31_correlate-ecDNA-status/correlate-ecDNA.ipynb

I have T/F ecDNA classifications, and ~10 clusters. The appropriate statistical
 test here is Fisher's exact or chi-sq.

Chi-sq or fisher's exact? 
 Handbook of Biological statistics says Chi-sq.
 http://www.biostathandbook.com/small.html

rcmb56-ht, ecDNA1
chi2	p-value	dof	tbl
(122.70641161067402,
 5.1707307869032215e-21,
 11,
                  size  observed (%)  expected (%)
 seurat_clusters                                  
 0                 712     92.837079     91.894737
 1                 668     84.730539     91.894737
 2                 527     92.789374     91.894737
 3                 491     91.649695     91.894737
 4                 378     92.857143     91.894737
 5                 344     98.546512     91.894737
 6                 307     99.022801     91.894737
 7                 102     79.411765     91.894737
 8                  97     95.876289     91.894737
 9                  63     85.714286     91.894737
 10                 57    100.000000     91.894737
 11                 54     87.037037     91.894737)

rcmb56-ht, ecDNA2
(54.32212918572303,
 1.0309151327899141e-07,
 11,
                  size  observed (%)  expected (%)
 seurat_clusters                                  
 0                 712     99.297753     98.894737
 1                 668     96.556886     98.894737
 2                 527     99.430740     98.894737
 3                 491     99.185336     98.894737
 4                 378     99.735450     98.894737
 5                 344    100.000000     98.894737
 6                 307     99.674267     98.894737
 7                 102     96.078431     98.894737
 8                  97    100.000000     98.894737
 9                  63    100.000000     98.894737
 10                 57    100.000000     98.894737
 11                 54     98.148148     98.894737)
 
 rcmb56-pdx, ecDNA1
(177.85115306787384,
 7.734039612624224e-29,
 17,
                  size  observed (%)  expected (%)
 seurat_clusters                                  
 0                1836     99.400871     98.477958
 1                1436     97.701950     98.477958
 2                 977     99.488229     98.477958
 3                 974     99.075975     98.477958
 4                 850     99.411765     98.477958
 5                 762     99.737533     98.477958
 6                 726     95.730028     98.477958
 7                 469     96.588486     98.477958
 8                 462     99.783550     98.477958
 9                 454     99.559471     98.477958
 10                393     98.982188     98.477958
 11                378     93.386243     98.477958
 12                316     98.101266     98.477958
 13                208     96.634615     98.477958
 14                186     99.462366     98.477958
 15                141    100.000000     98.477958
 16                136     95.588235     98.477958
 17                 71    100.000000     98.477958)
 
rcmb56-pdx, ecDNA2 
(66.00676531429008,
 1.038054696589301e-07,
 17,
                  size  observed (%)  expected (%)
 seurat_clusters                                  
 0                1836     99.945534     99.610209
 1                1436     99.860724     99.610209
 2                 977     98.259980     99.610209
 3                 974     99.691992     99.610209
 4                 850     99.764706     99.610209
 5                 762     99.606299     99.610209
 6                 726     99.586777     99.610209
 7                 469     99.786780     99.610209
 8                 462     99.134199     99.610209
 9                 454     99.779736     99.610209
 10                393    100.000000     99.610209
 11                378     99.735450     99.610209
 12                316    100.000000     99.610209
 13                208    100.000000     99.610209
 14                186     99.462366     99.610209
 15                141     98.581560     99.610209
 16                136     99.264706     99.610209
 17                 71    100.000000     99.610209)
 
DISCUSSION
Tests say there's significant deviation, but the effect size is very minor. 
There are a lot of clusters here. Re-run with lower cluster number?
Increase resolution parameter?

(How do I decide what an optimal resolution is?)

9/7/2021

MetaCell

BACKGROUND
We are still looking for a way to measure RNA expression of ecDNA genes against their ecDNA
predictions. Alex suggested MetaCell:
https://github.com/tanaylab/metacell/
https://genomebiology.biomedcentral.com/articles/10.1186/s13059-019-1812-2
Which uses a knn-based approach to build small clusters of ~20 cells as "metacells" which
are transcriptionally similar.

METHODS
conda activate metacell
R
install.packages("RSvgDevice_0.6.4.4.tar.gz", repos=NULL, type="source")
if (!require("BiocManager")) install.packages('BiocManager') 
BiocManager::install("remotes")
BiocManager::install("tanaylab/metacell")

Running on expanse scRNA+ATAC feature set
/expanse/lustre/projects/csd677/collab/projects/scRNA+ATAC/2021-09-07_metacell
Derived largely from code at:
https://tanaylab.github.io/metacell/articles/a-basic_pbmc8k.html

RESULTS
27 metacells from 2739 high-variance features.
Sure looks like these metacells are just defined by sequencing depth... See 
 rcmb56-ht_KEGG_CELL_CYCLE.png heatmap.
 
9/8/2021

Correlation with ARHGAP29

BACKGROUND
ARHGAP29 shows as much more highly "expressed" in metacell heatmaps. Is it a better candidate
oncogene?

METHODS
Generated correlations with ARHGAP29 to ecDNA z-scores alongside DNTTIP2
Compared distribution of normalized UMI counts between ARHGAP29 and DNTTIP2 (seurat)

RESULTS
Almost zero correlation between ARHGAP29 and ecDNA1 z-score.
ARHGAP29 expressed at much lower absolute level than DNTTIP2.

DISCUSSION
What is going on with overall single cell expression distributions?
Could be that the heatmaps are not sample- and gene-normalized.


9/10/2021

Inconsistent classifications between copy-scAT and poisson permutation test

BACKGROUND
My permutation test calls much more ecDNA than copy-scAT. More sensitive test, or false positives?
Jill suggested I visually examine cells which copy-scAT classifies as ecDNA- and I classify as
 ecDNA+.
 
METHODS
bigwigs generated on cluster at /expanse/lustre/projects/csd677/collab/projects/scRNA+ATAC/bigwig/
igv session at ~/Documents/Mesirov/scRNA+ATAC/2021-08-27_Kazachkova/bigwig/RCMB56-pdx/

RESULTS
It's noisy data, and the signal is there but not glaringly obvious. By visual examination, all F/T
 cells I randomly selected have enriched scATAC-seq reads at the known ecDNA1 location; and enrichment
 is comparable, but perhaps slightly less, than T/T cells by comparison.
 
9/10/2021

nCounts_RNA threshold

BACKGROUND
Seurat recommends nCount_RNA > 1000 in its tutorials, but many of the RCMB56-ht cells have between 
 100 and 1000 UMIs. Is there good reason to keep these?

METHODS
Literature search.

RESULTS

Harvard Chan Bioinformatics Core: https://hbctraining.github.io/scRNA-seq/lessons/04_SC_quality_control.html
 "The UMI counts per cell should generally be above 500, that is the low end of what we expect. 
 If UMI counts are between 500-1000 counts, it is usable but the cells probably should have been 
 sequenced more deeply."

UCD/UCSF: https://ucdavis-bioinformatics-training.github.io/2019-single-cell-RNA-sequencing-Workshop-UCD_UCSF/scrnaseq_analysis/scRNA_Workshop-PART2.html
 "We use the information above to filter out cells. Here we choose those that have percent 
  mitochondrial genes max of 10% and unique UMI counts under 20,000 or greater than 500."
 
Seurat Guided Clustering Tutorial
 "We filter cells that have unique feature counts over 2,500 or less than 200
 We filter cells that have >5% mitochondrial counts"

Seurat Weighted Nearest Neighbor Analysis
"pbmc <- subset(
  x = pbmc,
  subset = nCount_ATAC < 7e4 &
    nCount_ATAC > 5e3 &
    nCount_RNA < 25000 &
    nCount_RNA > 1000 &
    percent.mt < 20
)"

Babraham Institute: https://www.bioinformatics.babraham.ac.uk/training/10XRNASeq/seurat_workflow.html
subset(
  data,
  nFeature_RNA>750 & 
    nFeature_RNA < 2000 & 
    percent.MT < 10 & 
    Percent.Largest.Gene < 20
) -> data

BaRC Whitehead Institute for Biomedical Research: http://barc.wi.mit.edu/education/hot_topics/scRNAseq_2020/SingleCell_Seurat_2020.html
seurat <- subset(seurat, subset = nFeature_RNA > 350 & nFeature_RNA < 5000 & percent.mt < 10)

DISCUSSION
Many groups don't use UMI counts per cell at all; they instead prefer to threshold on number of distinct genes.
Seurat recommends nCount_RNA > 1000, and I saw 2 workshops from reputable sources saying at least 500.
Based on this, will adjust minimum threshold to 500.


9/14/2021

Correlate z-scores of ecDNAs 1 & 2

METHODS
see scRNA+ATAC/2021-08-31_correlate-ecDNA-status/correlate-ecDNA.ipynb

RESULTS
Correlation r=0.66.
Notes:
 Cluster 5 is exclusively high in ecDNA1.
 Cluster 3 relatively low in both.
 Clusters 8, 10 exclusively low in both.

9/14/2021

metacells and seurat clusters

Which metacells correspond to which clusters, and vice-versa?

METHODS
see /scRNA+ATAC/2021-09-07_metacell/metacells_and_clusters.ipynb

RESULTS

cluster 0 is composed of ~26 small metacells.
cluster 1 is composed of most of mcs 1,2,5,6,11
cluster 2 is also composed of ~26 metacells. Much overlap with 1.
cluster 3 has contributions from many, but the majority of mcs 7,8,9,10
cluster 4 is mc 3
cluster 5 is mc 13
cluster 6 is mcs 14,15,16
cluster 7 is mc 20
cluster 8 is mc 17
cluster 9 is mc 19, part of 18
cluster 10 is mc 18

TODO:
Put metacells on that ecDNA1,2 correlation thing.

9/15/2021

Metacell marker genes

Cluster 1 markers:
	PLCG2 - microglia and granules https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6359863/
	AL627171 - No info
	LINC0063 - Exosomal oncogene.
	MTRNR2L1 - No data
Cluster 3 - no markers
Cluster 4:
	EPHA6 - "hippocampus, various regions of the cortex, and retina" https://www.sciencedirect.com/science/article/pii/S0304394008004722?casa_token=Dx2s2xGdBtYAAAAA:7zrlDl9ptLhTxwj6Hin0ZPbjCh9hUAEbrWUfKB6ypjUeOK2jXdZwMCAlBAJ0JXKgPk8Owha6Uos#bib15
		Panglaodb - germ cells??
Cluster 5:
	RNF220 - SHH MB marker. https://journals.biologists.com/dev/article/147/21/dev188078/226332/RNF220-is-required-for-cerebellum-development-and
	CASC15 - Oncogene, downregulates PDCD4. Rercruits EZH2 for H3K27 trimethylation at PCDC4 promoter. https://cellandbioscience.biomedcentral.com/articles/10.1186/s13578-018-0240-4
	DCC - spermatids https://www.proteinatlas.org/ENSG00000187323-DCC/celltype.
		Tumor suppressor, binds netrin-1, axonal guidance. https://www.nature.com/articles/27441
Cluster 6:
	CCND3 - Cell cycle. Binds CDK4/5. Probable oncogene.
	FKBP5 - Stress response. glucocorticoid receptor pathway. hippocampus. https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0016883
	ARHGAP15 - Immune cell marker. https://www.proteinatlas.org/ENSG00000075884-ARHGAP15/celltype
	DPYD - Immune cells, especially Kupffer cells. https://www.proteinatlas.org/ENSG00000188641-DPYD/celltype
		OPC marker (Sunita's table)
	PLXDC2 - Immune, brain and undifferentiated cells. https://www.proteinatlas.org/ENSG00000120594-PLXDC2/celltype
		Neuronal differentiation signal: https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0014565
		"Endothelial cells of tumor stroma, NPCs, and PSCs. https://www.liebertpub.com/doi/abs/10.1089/mab.2019.0050?casa_token=2_TksadeK6gAAAAA:Ql-V8XJUK2zu043QQ63zMRSrCJ7X9qbRZ2YzBpejPRTWr48K0gT1LqAqeOfDa2AqBl-Asc-SijAy
	FRMD4A (with cluster 8) - tumor marker?
	LRMDA - epithelial and immune cells https://www.proteinatlas.org/ENSG00000148655-LRMDA/celltype
Cluster 7:
	PCDH9 - oligodendrocyte marker. Sunita's table.
	MBP - oligodendrocyte marker. Sunita's table.
	CTNNA3 (with cluster 9): Tumor suppressor, WNT pathway?
	PPP2R2B (with cluster 9): brain and spermatids https://www.proteinatlas.org/ENSG00000156475-PPP2R2B/celltype
		WNT pathway agonist https://link.springer.com/content/pdf/10.1007/s13353-015-0312-7.pdf
	Also high in RNF220, DPYD
Cluster 8:
	INPP4B - No tissue specificity, PI3K pathway. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3248162/
	SYN3 - HPA says spermatids. Neuronal gene. Synaptic vesicle protein.
	KCNMA1 - Calcium channel, Neuronal. https://www.proteinatlas.org/ENSG00000156113-KCNMA1/celltype
		Oncogene.
	FRMD4A
Cluster 9:
	NPAS3 - Developmental brain. Neuronal PAS domain protein 3 -> neurons marker?
	GRIA1 - Neuronal marker (Sunita's table). Glutamate receptor.
		Neurons and glial cells https://www.proteinatlas.org/ENSG00000155511-GRIA1/celltype
Cluster 10:
	DSCAM - OPC (Sunita's table)
		Developmental brain.
	TNR - OPC (Sunita's table).
		Cancer stem cell marker? https://pubs.acs.org/doi/abs/10.1021/pr5008653 https://link.springer.com/article/10.1186/s12935-020-01188-w
		Co-expressed with Gli1, SMO
	
DISCUSSION
Cluster 1: microglia/granule-like?
Cluster 5: Tumor
MC 11: RBCs
Cluster 6: TAMs, CSCs?
Cluster 7: Oligodendrocyte-like tumor cells
Cluster 8: Neuronal-like
Cluster 9: Neuronal/glial-like?
Cluster 10: OPC-like

9/15/2021

KMT2E, aka MLL5

MLL5 Orchestrates a Cancer Self-Renewal State by Repressing the Histone Variant H3.3 and Globally Reorganizing Chromatin
MLL5 (KMT2E): structure, function, and clinical relevance
	CD domain binds p53 tetramer!
	
DISCUSSION
Add MLL5 to manuscript.

9/15/2021

NB: Correlated KMT2E against ecDNA2.
 rcmb56-ht, ecDNA1 vs DNTTIP2 -- r=0.29
 rcmb56-ht, ecDNA2 vs KMT2E ---- r=0.42
 rcmb56-pdx, ecDNA1 vs DNTTIP2 - r=0.48
 rcmb56-pdx, ecDNA2 vs KMT2E --- r=0.57

Correlate ecDNA z-scores to gene expression, aggregated at metacell level.

RESULTS

rcmb56-ht, ecDNA1 vs DNTTIP2.
Outliers in both distributions, so Pearson invalid.
SpearmanrResult(correlation=0.47579737335834904, pvalue=0.0019152445344766435)
High values metacells 11, 12, 13

rcmb56-ht, ecDNA2 vs KMT2E.
SpearmanrResult(correlation=0.24709193245778616, pvalue=0.12425968094198284)
High values metacells 11, 12, 13

DISCUSSION
Spearman correlation present but insignificant. Pearson has outliers but outliers are high 
on both axes so they don't deviate much from the line of best fit. Pearson ok then?

9/20/2021

Ashwyn

singleR
Panglaodb
Scrublet

Velocity and pseudotime not terribly effective.


9/20/2021

Scrublet

BACKGROUND
Ashwyn recommends running a specific doublet detection algorithm. Scrublet is well-known, so I started here.

RESULTS
Scrublet is unable to detect doublets in either RCMB56 sample.
Histograms are unimodal.

DICSUSSION
This result makes sense. From an issue on the github, "scrublet histogram is not bimodal"
 "...the simulated doublet score distribution is bimodal only if the simulated doublets include an appreciable 
 fraction of each of the two "types" of doublets, neotypic (high scoring, distinct from singlets) and embedded 
 (low scoring, similar to singlets). The fact that your simulated doublet score distribution only has a left 
 mode suggests that for your data and method of analysis (in this case, the default preprocessing used by 
 scrub_doublets()), most doublets are embedded and therefore not detectable. This typically happens when 
 there isn't much complexity in the sample, i.e., most random pairs of cells are similar to each other 
 and create doublets that resemble themselves."
We know most of these cells look like tumor; and so we are unlikely to have neotypic and very likely to have embedded
doublets. Furthermore, a hypothetical doublet of 2 ecDNA+ cells probably looks a lot like 1 cell with more ecDNA...

9/24/2021

copyKAT

METHODS
conda install -c r r-base r-devtools
conda install -c conda-forge r-seuratobject
library(devtools)
install_github("navinlabcode/copykat")

10/2/2021

Cell type annotations

METHODS
Take FindAllMarkers output, fdr q<0.05, run overlap with MSigDB C8.
NB: max 2038 genes allowed in query.

RESULTS
Cluster 0 (n=3338) - GABAergic neurons, neuroblast GABAergic, dopaminergic neurons
Cluster 1 (n=390) - GABAergic neurons, gastric immune cells, kidney, neuroblast GABAergic, serotonergic neurons
Cluster 2 (n=112) - epithelial
Cluster 3 () - GABAergic neurons, gastric immune cells, kidney, neuroblast GABAergic, serotonergic neurons, pancreas beta cells,
	dopaminergic neurons, mediolateral neuroblasts...
Cluster 4 (n=385) -  GABAergic neurons, neuroblast GABAergic, dopaminergic neurons...
Cluster 5 (n>2038) - GABAergic neurons, neuroblast GABAergic, dopaminergic neurons, mesenchymal pancreatic stroma
Cluster 6 (n=1612) - microglia
Cluster 7 (n=1362) - oligodendrocytes, manno midbrain neurotypes
Cluster 8 (n=1805) - manno midbrain neurotypes
Cluster 9 (n=1061) - radial glial cells, astrocytes, manno midbrain neurons, opcs.
Cluster 10 (n=831) - opcs, manno midbrain neurons, radial glial cells, astrocytes

10/3/2021

McKenzie brain cell type markers

McKenzie et al 2018 do a meta-analysis to assemble expression markers of six cell types in the brain:
 astrocytes, endothelial cells, microglia, neurons, oligodendrocytes, and OPCs.
 This included the top 100 most co-cited (gene + cell type) in PubMed abstracts, and one vs each DE.

I asked which McKenzie brain cell type was most found among the differential genes of each cluster (Seurat).

Pubmed most co-cited
cluster 0: neu
cluster 1: neu
cluster 2: neu
cluster 3: neu
cluster 4: neu
cluster 5: neu
cluster 6: mic
cluster 7: oli
cluster 8: neu
cluster 9: ast
cluster 10: opc

Specific DE
cluster 0: neu
cluster 1: neu
cluster 2: oli
cluster 3: neu
cluster 4: neu
cluster 5: neu
cluster 6: mic
cluster 7: oli
cluster 8: neu
cluster 9: ast
cluster 10: opc

10/4/2021

Plot expression of known biomarkers for putative cell types

METHODS
2021-10-02_marker-annotation/2021-10-04_plot-marker-gene-expression.ipynb

RESULTS
Oddly, many known biomarkers aren't expressed much in any cells at all. Could be a problem of using FC
 as an ordering metric. Anyway,

Cell type markers
 MBP - Oligodendrocyte marker. Robustly expressed in cluster 7.
 CD86 - marker for antigen-presenting cells: macrophage, dendritic cells, microglia. Subset of cluster 6.
 PTPRC - aka CD45. Canonical marker for all differentiated immune cells. Cluster 6.
 NDRG2 - Astrocyte marker. Cluster 9.
 TNR - OPC marker. Robustly expressed in cluster 10.
 PDGFRA - OPC marker. cluster 10.

A few SHH MB genes:
 GLI2 - Overexpressed in cluster 5, one cell in 9?
 SMO - Scattered expression cluster 5
 DNTTIP2 - Cluster 5
 KMT2E - strong in cluster 5, scattered in 0-4.

DISCUSSION
These could easily be a supplemental figure. Also, 5 is high in both ecDNA z-scores, and 6-10 are low. 
Going to define nontumor cells as those from clusters 6-10 with low ecDNA1 and 2 z-scores.

10/5/2021

There are actually no cells in clusters 6, 7, 9, and 10 which are predicted ecDNA- for all 3. 

Across all clusters, the number of cells which are ecDNA- for all is 17. I must have been thinking of an 
older version of the analysis when I reported that 85% of cells are ecDNA+ in the human tumor; I think 
most of these 15% were cells were low-quality according to seurat.
 Most likely explanation - I have too high a FPR when calling ecDNA.
 Second most-likely explanation - all but 17 cells in rcmb56-ht have ecDNA.
This is frustrating and sets us back a bit. I'm going to review the ecDNA hypotheses for cells in these 
seurat clusters to see if I really think they all look like ecDNA.

10/5/2021

Took a look at the rcmb56-ht cluster 6 bigwig coverage tracks. For most there is no evidence of ecDNA.
A few clear ecDNA+ cells, and some ambiguous coverage tracks.

10/6/2021
Generated bw tracks of clusters 6,7,9,10. 
/expanse/lustre/projects/csd677/collab/projects/scRNA+ATAC/bigwig/RCMB56-ht

10/6/2021

A new null for ecDNA detection

BACKGROUND
Many of the cells in cluster 6 show limited or no evidence of ecDNA enrichment, yet they are all classified
as ecDNA+. One hypothesis for this is that I sample from essentially the entire genome, using the GRCh38 
regions in the AA data repo, which exclude centromeres, telomeres, and little else. 

A better background might be: all regions detected in ecDNA in other SHH? MB samples.

METHODS
Bed files are available at C:\Users\ochapman\Documents\Mesirov\medullo_ecDNA\amplified-intervals-bed\cohort
/home/ochapman/Documents/Mesirov/scRNA+ATAC/2021-10-07_better-background

RESULTS
Total genomic region length of MB patient tumors and pdx: 
 161562466, 162Mbp


10/6/2021

Correlate z-scores to gene expression
Log-scaled z-scores, switched from scatterplot to displot

 rcmb56-ht, ecDNA1 vs DNTTIP2 -- r=0.26
 rcmb56-ht, ecDNA2 vs KMT2E ---- r=0.37
 rcmb56-pdx, ecDNA1 vs DNTTIP2 - r=0.46
 rcmb56-pdx, ecDNA2 vs KMT2E --- r=0.68
 
10/8/2021
Zero-inflated poisson model:
https://towardsdatascience.com/an-illustrated-guide-to-the-zero-inflated-poisson-model-b22833343057

10/11/2021

SingleR

RCMB56-ht results - mostly astrocytes, some neurons.
Cluster 6 - still immune cells
Clusters 0-5 - neurons and astrocytes, endothelial in 5.
Cluster 8 - astrocyte


10/13/2021

Better background

BACKGROUND
Previously, I had estimated p-values by comparing the ecDNA mean sampling density to that of 1000
 random regions across the genome. Jens pointed out earlier that this may be too weak a null, since
 it is known that ecDNA comes from gene-dense regions. I also found that nearly no cells were ecDNA- 
 according to this approach.
 
GOAL
Sample from only gene-dense regions

METHODS
 Convert all ecDNA bed files to hg38
 Agglomerate, use this as null
 
* NB. Initially, I was getting much much lower p-values using this approach, which should be impossible.
 This led me to find 2 bugs in my code:
   I was not dividing by ecDNA length
   featurecounts by default only assigns a read to one of overlapping regions.

RESULTS

genome bg:
 272 ecDNA- cells (9%)
 by subgroup:
  321 / 2986 ecDNA1+
  2693 / 2986 ecDNA2+
  0 / 2986 ecDNA3+
ecdna bg:
 2703 ecDNA- cells (91%)
 by ecDNA:
  263 / 2986 ecDNA1+
  126 / 2986 ecDNA2+
  0 / 2986 ecDNA3+
 

In cluster 6, 
 CCAACCCGTTTGGGCG-1	< clear TP
 CTTGAATCACAAGCCT-1	< clear TP
 GCCTCAAAGGAATAAC-1	< probable TP
 TCTAACCGTGTTGCAA-1	< probable FP
are classified ecDNA1+ by both approaches. In addition the ecDNA-only classifier calls
 GAAAGCCAGTAACGAG-1	< probable TP
 
Furthermore, in cluster 6,
 CCAACCCGTTTGGGCG-1	
 CTTGAATCACAAGCCT-1	
 GCCTCAAAGGAATAAC-1
are classified ecDNA2+ by both approaches. An additional 48 are classified ecDNA+ by genome.

ecDNA1 by cluster:
(genome)
 cluster 0.0 ecDNA+: 49 / 771 (6%)
 cluster 1.0 ecDNA+: 45 / 523 (9%)
 cluster 2.0 ecDNA+: 20 / 464 (4%)
 cluster 3.0 ecDNA+: 22 / 422 (5%)
 cluster 4.0 ecDNA+: 13 / 350 (4%)
 cluster 5.0 ecDNA+: 154 / 172 (90%)
 cluster 6.0 ecDNA+: 4 / 79 (5%)
 cluster 7.0 ecDNA+: 3 / 72 (4%)
 cluster 8.0 ecDNA+: 1 / 53 (2%)
 cluster 9.0 ecDNA+: 8 / 44 (18%)
 cluster 10.0 ecDNA+: 2 / 36 (6%)
(ecdna)
 cluster 0.0 ecDNA+: 36 / 771 (5%)
 cluster 1.0 ecDNA+: 33 / 523 (6%)
 cluster 2.0 ecDNA+: 13 / 464 (3%)
 cluster 3.0 ecDNA+: 16 / 422 (4%)
 cluster 4.0 ecDNA+: 9 / 350 (3%)
 cluster 5.0 ecDNA+: 139 / 172 (81%)
 cluster 6.0 ecDNA+: 5 / 79 (6%)
 cluster 7.0 ecDNA+: 3 / 72 (4%)
 cluster 8.0 ecDNA+: 1 / 53 (2%)
 cluster 9.0 ecDNA+: 7 / 44 (16%)
 cluster 10.0 ecDNA+: 1 / 36 (3%)

DISCUSSION
I do not think there is evidence to classify these additional 48 as ecDNA+, but it's quite 
difficult to tell because the regions are so short.
This recommends the ecDNA background. 
Also, I asked 10x support whether atac_possorted_bam is deduplicated.

NB. Need to compare my results to copy-scAT again in IGV. Previously, we had thought that
copy-scAT called many false negatives based on visual inspection. Now my own test is telling
me no evidence of ecDNA??

10/18/2021

Deduplicating reads

GOAL
Found out from 10x that the bam file I've been using (atac_possorted_bam.bam) is not 
 deduplicated. Need to do this myself, it seems.
There are 2 obvious approaches: one is to subset the bam into each cell, and run picard 
 markduplicates on each. The other is to separate atac_fragments.tsv.gz by barcode. I have
 opted for the second approach.
 
METHODS
See /expanse/lustre/projects/csd677/collab/projects/scRNA+ATAC/2021-10-18_fragments-tsv-gz
 * NB need to check if it's a valid barcode. 500k raw barcodes, 4k filtered barcodes.
 
RESULTS
See 2021-11-01 update.
Of note, once I use the deduplicated fragments, the backgrounds return pretty much the same
 results (for ht and pdx). 


11/2/2021

ecDNA classification evaluation

GOAL
How confident should I be in this latest iteration?


RESULTS
# how different are the genome and ecDNA backgrounds?
	Very little difference between the two backgrounds
	
# how concordant are my classifications with copy-scAT?
	Low concordance for both. Eg ht, I call 263 cells ecDNA1+. Copy-scAT agrees with just 84 of those.
	The distribution of my classes to copyscat classes looks almost random, except for a few (I get all LQ cells)
	
# How would I classify the discordant examples?
	* Plot bw in igv.
	true in both: 84 cells. These look like ecDNA.
	tf (true in permutation test, false in cs): 116 cells. With few exceptions, these also look ecDNA+.
	ft (false in permutation test, true in cs): 11 cells. 2 with obvious ecDNA, ATTGCGCCATTGTGGC-1.bw and TGTTCCTCACCTCACC-1.bw
		Misclassified ft cells have significant p-values, but significance lost upon multiple hypothesis correction.
# How well do they correlate to marker expression?
	Performed 2 tests: gene expression vs ecDNA classification, and gene expression vs z-score
	permutations, ht, dnttip2:
		Cohen's d: 1.202969949701343
		MannwhitneyuResult(statistic=247887.0, pvalue=7.735823625300748e-17)
	copyscat, ht, dnttip2:
		Cohen's d: 1.2753838794768697
		MannwhitneyuResult(statistic=124872.5, pvalue=6.481381382686321e-15)		
	permutations, ht, kmt2e:
		Cohen's d: 3.239386980320031
		MannwhitneyuResult(statistic=73882.0, pvalue=1.5545189553872433e-28)
	copyscat, ht, dnttip2:
		Cohen's d: 2.362081272384823
		MannwhitneyuResult(statistic=54414.5, pvalue=9.196600827169476e-11)
	permutations, pdx dnttip2:
		Cohen's d: 0.700528492296191
		MannwhitneyuResult(statistic=1229044.5, pvalue=2.4651271871945223e-93)
	copyscat, pdx, dnttip2:
		Cohen's d: 0.791191739205213
		MannwhitneyuResult(statistic=5025388.0, pvalue=6.634138431916924e-200)
	permutations, pdx, kmt2e:
		Cohen's d: 1.164068525493985
		MannwhitneyuResult(statistic=570647.0, pvalue=0.0)
	copyscat, pdx, kmt2e
		Cohen's d: 0.868610961218862
		MannwhitneyuResult(statistic=4688886.5, pvalue=4.141271893894807e-275)
		
	Both classifiers have strong association with gene expression.
	
	gene expression vs z-score
		ht: weak association for both ecDNAs
		pdx: strong association for both ecDNAs.

# How do they distribute by seurat cluster?
	Cluster 5 enriched for both ecDNA.
	
	
11/12/2021

Xenocell

GOAL
Filter mouse cells.

METHODS
Got xenocell working, see /expanse/lustre/projects/csd677/collab/projects/scRNA+ATAC/2021-11-01_xenocell. 
 The important file is graft/barcodes.txt, which lists all barcodes with >90% of uniquely mapping reads 
 mapped to the human genome. Of interest also is this plot showing the distribution of reads uniquely 
 mapping to mouse or human. It looks like we have many barcodes which include a substantial portion of 
 reads from both genomes. These could be doublets, or RNA leakage, or maybe extracellular ecDNA??
 
Updated 2021-08-29_seurat/seurat_preprocess_and_cluster.ipynb to filter for human cells.


